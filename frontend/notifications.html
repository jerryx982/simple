<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleCrypto | Notifications</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <header>
        <a href="index.html" class="logo">SimpleCrypto</a>
        <div class="user-menu-container">
            <!-- Bell Icon injected here by JS -->
            <button id="user-menu-btn" class="user-menu-btn">
                <div class="profile-icon">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                </div>
                <span id="user-name-display">User</span>
                <svg class="chevron" viewBox="0 0 24 24">
                    <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
                </svg>
            </button>
            <div id="user-dropdown" class="user-dropdown">
                <a href="profile.html">Profile</a>
                <a href="security.html">Security</a>
                <div class="dropdown-divider"></div>
                <a href="#" id="logout-btn">Logout</a>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <a href="dashboard.html">Dashboard</a>
            <a href="index.html#plans">New Investment</a>
            <a href="deposit.html">Deposit</a>
            <a href="kyc.html">KYC Verification</a>
            <a href="profile.html">Profile</a>
            <a href="security.html">Security</a>
            <a href="withdraw.html" id="withdraw-link-btn">Withdraw</a>
        </aside>

        <button id="sidebar-toggle" class="sidebar-toggle-btn">
            <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
            </svg>
        </button>

        <main class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>Notifications</h2>
                <button id="mark-all-read-btn" class="btn btn-outline" style="font-size: 0.9rem;">Mark all read</button>
            </div>

            <div id="notification-list" class="notification-list">
                <!-- Notifications loaded here -->
                <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading...</div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await requireAuth();
            updateUserHeader(user);

            // Logic to load notifications
            const list = document.getElementById('notification-list');
            try {
                const res = await API.get('/api/notifications');
                if (Array.isArray(res) && res.length > 0) {
                    renderNotifications(res);
                } else {
                    list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No notifications yet</div>';
                }
            } catch (e) {
                list.innerHTML = '<div style="color: var(--error);">Failed to load notifications</div>';
            }

            // Mark All Read Handler
            document.getElementById('mark-all-read-btn').addEventListener('click', async () => {
                const res = await API.post('/api/notifications/read', { notificationId: 'all' });
                if (res.ok) {
                    window.showToast('All notifications marked as read', 'success');
                    // Reload
                    location.reload();
                }
            });
        });

        function renderNotifications(items) {
            const list = document.getElementById('notification-list');
            list.innerHTML = '';

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `notification-item ${item.isRead ? 'read' : 'unread'}`;

                // Icon based on type
                let icon = '';
                if (item.type === 'login') icon = '<svg viewBox="0 0 24 24" style="fill:#58a6ff"><path d="M11 7L9.6 8.4 12.2 11H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></svg>';
                else if (item.type === 'withdrawal') icon = '<svg viewBox="0 0 24 24" style="fill:#238636"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>';
                else if (item.type === 'free_plan_activated') icon = '<svg viewBox="0 0 24 24" style="fill:#8a2be2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.29 0 2.13-.72 2.13-1.71 0-1.12-.57-1.59-2.3-2.16-2.03-.68-3.1-1.61-3.1-3.22 0-1.67 1.25-2.93 2.95-3.32V6h2.67v1.93c1.38.3 2.48 1.12 2.66 2.87h-1.96c-.25-1.12-1.07-1.61-2.17-1.61-1.14 0-1.92.59-1.92 1.48 0 1.05.65 1.48 2.37 2.06 1.83.63 2.97 1.63 2.97 3.32 0 1.77-1.39 3.01-3.04 3.36z"/></svg>'; // Money/Dollar icon
                else if (item.type === 'free_plan_completed') icon = '<svg viewBox="0 0 24 24" style="fill:#e0ac00"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"/></svg>'; // Star icon

                el.innerHTML = `
                    <div class="notif-icon">${icon}</div>
                    <div class="notif-content">
                        <div class="notif-message">${item.message}</div>
                        <div class="notif-time">${new Date(item.createdAt).toLocaleString()}</div>
                    </div>
                    ${!item.isRead ? '<div class="unread-dot"></div>' : ''}
                `;

                // Click to mark as read
                if (!item.isRead) {
                    el.addEventListener('click', async () => {
                        await API.post('/api/notifications/read', { notificationId: item._id });
                        el.classList.remove('unread');
                        el.classList.add('read');
                        el.querySelector('.unread-dot')?.remove();
                        updateNotificationBadge(); // In app.js
                    });
                }

                list.appendChild(el);
            });
        }
    </script>
</body>

</html>